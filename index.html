<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>YOUR WEBSITE NAME HERE</title>
    <meta name="description" content="DESCRIBE  YOUR WEBSITES CONTENT / PURPOSE HERE">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="images/logo.svg">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:500&display=swap" rel="stylesheet">

    <link rel="stylesheet"
          href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.3.1/build/styles/base16/material-darker.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.3.1/build/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>

<header>
    <a class="logo" href="index.html"><img src="images/logo.svg" alt="logo"></a>
    <nav>
        <ul class="nav__links">
            <li id="MoveToTop"><a href="index.html">Home</a></li>
        </ul>
    </nav>
    <a class="cta" href="contact.html">About</a>
    <p class="menu cta">Menu</p>
</header>

<div id="mobile__menu" class="overlay">
    <a class="close">&times;</a>
    <div class="overlay__content">
        <a href="index.html">Home</a>
        <a href="contact.html">About</a>
    </div>
</div>

<div class="content">
    <div class="container">
        <h1>Node.js Web-Server Setup</h1>
    </div>
    <div class="container">
        <!-- TABLE TEMPLATE -->
        <h2>Table of Contents</h2>
        <table id="table-template">
            <tr>
                <th>
                    Contents
                </th>
            </tr>
            <tr>
                <td><a class="link" href="#Installation">Installation</a></td>
            </tr>
            <tr>
                <td><a class="link" href="#Configuration">Configuration</a></td>
            </tr>
            <tr>
                <td><a class="link" href="#Setup">Setup</a></td>
            </tr>
        </table>

    </div>

    <div id="Installation" class="container">
        <h2>Installing Node.js</h2>
        <p>
            Download: <a class="link" href="https://nodejs.dev/en/download/">Node.js</a> restart PC when the
            installation has completed, open your IDE create a new project or use a current project. Create two files
            server.js and logEvents this will
            be where we write code to get the webserver itself running and to provide a log for the GET requests with
            time, date and what has been requested. Which will look something like this for the terminal and for the
            logfile itself below that:
        </p>
        <pre>
        <code>
/ GET
/css/style.css GET
/JS/mobile.js GET
/images/logo.svg GET
/images/image85q.webp GET
/images/logo.svg GET

20230124	10:30:17	812297ca-53d4-4545-88c6-7bc672878405	/	GET
20230124	10:30:17	13cf030e-cb0e-448d-9d2b-93dd83650284	/css/style.css	GET
20230124	10:30:17	6f8e980a-7a79-48a8-9d32-cfcf62712c35	/JS/mobile.js	GET
20230124	10:30:17	87a0340f-a821-4db6-96c5-8674f5eec223	/images/logo.svg	GET
20230124	10:30:17	e3717a9a-0528-43b4-8dd1-1cd15bf9f5d8	/images/image85q.webp	GET
20230124	10:30:17	6c9cc053-48bc-414f-afba-99c8805b60c0	/images/logo.svg	GET
        </code>
    </pre>
    </div>

    <!-- NODE SETUP = INSTALL REQUIRED DEPENDENCIES ETC. FILE DIRECTORIES.... | nmp i nodemon -g | globaly install nodemon | npm i date-fns  | npm i uuid | npm i nodemon -D|-->
    <div class="container">
        <h2 id="Configuration">Configuration</h2>
        <p>
            Let's get the required dependencies installed. Open the terminal in your IDE of choice and type
            <br/><em><b>npm i
            nodemon -g</b></em> which will monitor our files and automatically restarts the server when we save. Now
            let's do
            <br/><b><em>npm init</em></b> you can do <b><em>npm init -y</em></b> to automatically answer yes to all the
            questions. npm
            init will get our package.json file which NPM will read, so it knows what packages are installed in our
            project. Now install
            <br/><b><em>npm i date-fns</em></b> which we will use for our logging. you should now see that your
            package.json has the dependency "date-fns" As we add dependencies our node_modules folder will get quite
            large so add a <b>.gitignore</b> file and in the file write node_modules. Now if you clone your project from
            GitHub
            you will have to run
            <br/><b><em>npm install</em></b> to install the dependencies needed for the project.<br/> Write <b><em>npm i
            nodemon -D</em></b> to install nodemon as a dev dependency.</br> Now type <b><em>npm i uuid</em></b> which
            we will use to give unique IDs in our log.
        </p>
        <br>
        <p>
            In the package.json file add two scripts which will be "start" and "dev" we will use the dev script to run
            our server.
        <pre><code>
"scripts": {
    "start": "node server",
    "dev": "nodemon server"
  },
    </code></pre>
        Now our package file should look something like this:
        </p>
        <pre>
            <code class="language-json">
{
  "name": "your-project-name",
  "version": "1.0.0",
  "description": "Node.js Web Server tutorial",
  "main": "server.js",
  "scripts": {
    "start": "node server",
    "dev": "nodemon server"
  },
  "author": "your-name",
  "license": "ISC",
  "dependencies": {
    "date-fns": "^2.23.0",
    "uuid": "^8.3.2"
  },
  "devDependencies": {
    "nodemon": "^2.0.12"
  }
}
            </code>
        </pre>
    </div>
    <div class="container">
        <h2 id="Setup">Setup</h2>
        <p>
            Starting with logEvents.js we will create our logEvents module which we will use to log server requests to
            the terminal and to a text file that will have a unique ID for each entry and the time of the event. Feel
            free to change the date format to one that fits your needs this is done by editing "const dateTime"
        </p>
        <pre>
                <code>
const {v4: uuid} = require('uuid');

const fs = require('fs');
const fsPromises = require('fs').promises;
const path = require('path');

const logEvents = async (message, logName) => {
    const dateTime = `${format(new Date(), 'yyyyMMdd\tHH:mm:ss')}`;
    const logItem = `${dateTime}\t${uuid()}\t${message}\n`;
    try{
        if (!fs.existsSync(path.join(__dirname, 'logs'))){
            await fsPromises.mkdir(path.join(__dirname, 'logs'))
        }
        await fsPromises.appendFile(path.join(__dirname, 'logs', logName), logItem);
    } catch (err) {
        console.log(err)
    }
}

module.exports= logEvents;
                </code>
            </pre>
        <p>
            Now that our logEvents.js is done and exported for use in our server.js we can start setting up the server
            itself. We begin by importing the required packages then we set our desired port.
        </p>
        <pre>
            <code class="language-js">
const http = require('http');
const path = require('path');
const fs = require('fs');
const fsPromises = require('fs').promises;

const logEvents = require('./logEvents');
const EventEmitter = require('events');

class MyEmitter extends EventEmitter {
}
const myEmitter = new MyEmitter();
myEmitter.on('log', (msg, fileName) => logEvents(msg, fileName));
const PORT = process.env.PORT || 3500; // <-- Change to your desired port here

const serveFile = async (filePath, contentType, response) => {
    try {
        const rawData = await fsPromises.readFile(
            filePath,
            !contentType.includes('image', 'video') ? 'utf-8' : '');
        const data = contentType === 'application/json' ? JSON.parse(rawData) : rawData;
        response.writeHead(
            filePath.includes('404.html') ? 404 : 200,
            {'Content-Type': contentType})
        response.end(
            contentType === 'application/json' ? JSON.stringify(data) : data
        );
    } catch (err) {
        console.log(err);
        myEmitter.emit('log', `${err.name}: ${err.message}`, 'errLog.txt')
        response.statusCode = 500;
        response.end();
    }
}
            </code>
        </pre>
    </div>
    <figure>
        <a href="images/width=2968.jpg" target="_blank">
            <img src="images/image85q.webp" alt="A Picture">
        </a>
    </figure>
</div>
<footer>
    Made by Robin Begby @
    <a class="link" href="mailto:robinbeg@viken.no">Robinbeg@viken.no</a>
    <a class="link centerfooter" href="#MoveToTop">Move to top</a>
</footer>
<script type="text/javascript" src="JS/mobile.js"></script>
</body>
</html>
